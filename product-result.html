<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Your Creation | KalaKari AI</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Playfair+Display:wght@700&display=swap');
        :root {
            --success-color: #28a745; --font-color: #ffffff;
            --shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Poppins', sans-serif; color: var(--font-color); height: 100vh; overflow: hidden; }
        .background-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; filter: blur(15px) brightness(0.7); transform: scale(1.1); animation: fadeInBg 1.5s ease-out forwards; }
        .content-wrapper { display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; padding: 40px; }
        .product-card { display: flex; max-width: 1000px; width: 100%; height: 650px; background: rgba(0, 0, 0, 0.2); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.125); box-shadow: var(--shadow); opacity: 0; transform: translateY(20px); animation: fadeInCard 1s ease-out 0.5s forwards; }
        .product-image-preview { flex: 1; background-size: cover; background-position: center; border-radius: 20px 0 0 20px; }
        .product-details {
            flex: 1.2; padding: 25px 40px; display: flex;
            flex-direction: column; overflow-y: auto;
        }
        .product-details::-webkit-scrollbar { width: 8px; }
        .product-details::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .product-details::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 10px; }
        
        .section { margin-bottom: 20px; }
        .section-title { font-family: 'Playfair Display', serif; font-size: 1.3rem; margin-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 10px; }
        
        h1#productTitle { font-family: 'Playfair Display', serif; font-size: 2.5rem; font-weight: 700; line-height: 1.2; margin-bottom: 15px; }
        p#productDescription { font-size: 0.95rem; line-height: 1.7; opacity: 0.9; }
        
        .provenance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9rem; }
        .provenance-item strong { color: #D4AF37; }
        
        p#artisansNote { font-style: italic; opacity: 0.8; }

        #suggestions-grid { display: flex; flex-direction: column; gap: 10px; }
        .suggestion-card { background: rgba(0, 0, 0, 0.2); border-radius: 8px; padding: 10px 15px; }
        .suggestion-card h4 { margin: 0 0 5px 0; color: #D4AF37; font-size: 0.9rem; }
        .suggestion-card p { font-size: 0.85rem; margin: 0; line-height: 1.5; opacity: 0.8; }
        
        .publish-controls { margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.2); }
        .details-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; opacity: 0.9; }
        .input-group input, .input-group select { width: 100%; padding: 10px; font-size: 1rem; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(0,0,0,0.2); color: white; font-family: 'Poppins', sans-serif; }
        select option { color: #333; }
        .btn-publish { display: block; width: 100%; padding: 15px; text-align: center; text-decoration: none; font-weight: 600; font-size: 1.1rem; border-radius: 10px; transition: all 0.3s; border: none; cursor: pointer; background-color: var(--success-color); color: white; }
        .btn-publish:hover { background-color: #218838; transform: translateY(-2px); }
        
        @keyframes fadeInBg { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInCard { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="background-container" id="background-image"></div>
    <div class="content-wrapper">
        <div class="product-card">
            <div class="product-image-preview" id="product-image-preview"></div>
            <div class="product-details">
                <div id="loading-state">
                    <h1>Generating your Product Identity...</h1>
                    <p>Please wait while our AI analyzes your craft.</p>
                </div>
                
                <div id="loaded-content" style="display: none;">
                    <div class="section">
                        <h1 id="productTitle"></h1>
                        <p id="productDescription"></p>
                    </div>

                    <div class="section">
                        <h3 class="section-title">Provenance Report</h3>
                        <div class="provenance-grid">
                            <div class="provenance-item"><strong>Craft:</strong> <span id="craftType"></span></div>
                            <div class="provenance-item"><strong>Region:</strong> <span id="region"></span></div>
                            <div class="provenance-item"><strong>Materials:</strong> <span id="materials"></span></div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3 class="section-title">Artisan's Note</h3>
                        <p id="artisansNote"></p>
                    </div>

                    <div class="section">
                        <h3 class="section-title">AI Marketing Suggestions</h3>
                        <div id="suggestions-grid"></div>
                    </div>
                </div>

                <div class="publish-controls">
                    <div class="details-grid">
                        <div class="input-group"><label for="state">State</label><select id="state"></select></div>
                        <div class="input-group"><label for="craftCategory">Category</label><select id="craftCategory"><option>Decor</option><option>Fashion</option><option>Gifts</option></select></div>
                        <div class="input-group"><label for="productPrice">Price (â‚¹)</label><input type="number" id="productPrice" placeholder="2500"></div>
                    </div>
                    <button class="btn btn-publish" id="publishBtn">Publish to Marketplace</button>
                </div>
            </div>
        </div>
    </div>
    <script type="module">
        // --- YOUR UNIQUE FIREBASE CONFIG IS PASTED HERE ---
        const firebaseConfig = {
          apiKey: "AIzaSyD2pIlTugP5ioDx9ZU-BXP1BlTbdzwL4OU",
          authDomain: "sonic-terminal-472807-t9.firebaseapp.com",
          projectId: "sonic-terminal-472807-t9",
          storageBucket: "sonic-terminal-472807-t9.appspot.com",
          messagingSenderId: "983709128072",
          appId: "1:983709128072:web:5439cdf280c0f3bf27563d",
          measurementId: "G-HQZ8Y8GDE2"
        };

        // --- FIREBASE SETUP ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- SCRIPT LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const productDataJSON = localStorage.getItem('latestProduct');
            const artisans = JSON.parse(localStorage.getItem('artisans')) || {};
            const currentArtisanId = localStorage.getItem('currentArtisan');
            
            if (productDataJSON) {
                const productData = JSON.parse(productDataJSON);
                
                document.getElementById('productTitle').textContent = productData.product_title;
                document.getElementById('productDescription').textContent = productData.description;
                document.getElementById('craftType').textContent = productData.provenance.craft_type;
                document.getElementById('materials').textContent = productData.provenance.materials;
                document.getElementById('region').textContent = productData.provenance.region;
                document.getElementById('artisansNote').textContent = `"${productData.artisans_note}"`;
                
                document.getElementById('background-image').style.backgroundImage = `url(${productData.imageSrc})`;
                document.getElementById('product-image-preview').style.backgroundImage = `url(${productData.imageSrc})`;

                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('loaded-content').style.display = 'block';

                getMarketingSuggestions(productData.description);
                
                const stateSelect = document.getElementById('state');
                const allStates = [...new Set(Object.values(artisans).map(artisan => artisan.state))];
                allStates.sort();
                stateSelect.innerHTML = '';
                allStates.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    stateSelect.appendChild(option);
                });
                if (currentArtisanId && artisans[currentArtisanId]) {
                    stateSelect.value = artisans[currentArtisanId].state;
                }

                document.getElementById('publishBtn').addEventListener('click', async () => {
                    const price = document.getElementById('productPrice').value;
                    if (!price || parseFloat(price) <= 0) {
                        alert('Please enter a valid price.'); return;
                    }
                    
                    const finalProduct = {
                        ...productData,
                        price: parseFloat(price).toFixed(2),
                        state: document.getElementById('state').value,
                        craftCategory: document.getElementById('craftCategory').value,
                        artisanId: currentArtisanId
                    };
                    
                    try {
                        await addDoc(collection(db, "products"), finalProduct);
                        alert('Product published successfully!');
                        window.location.href = './dashboard.html';
                    } catch (e) {
                        console.error("Error adding document: ", e);
                        alert("Failed to publish product.");
                    }
                });

            } else {
                document.getElementById('productTitle').textContent = "No Product Found";
                document.getElementById('productDescription').textContent = "Please return to the dashboard and generate a product.";
            }
        });

        async function getMarketingSuggestions(description) {
            const grid = document.getElementById('suggestions-grid');
            grid.innerHTML = '<p style="font-size:0.9rem; opacity:0.7;">Generating marketing ideas...</p>';
            try {
                // --- THIS IS THE UPDATED LINE WITH YOUR LIVE URL ---
                const response = await fetch('https://kalakari-ai-backend-983709128072.asia-south1.run.app/generate-suggestions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description: description }),
                });
                if (!response.ok) { throw new Error('Failed to get suggestions.'); }
                const suggestions = await response.json();
                grid.innerHTML = '';
                suggestions.forEach(suggestion => {
                    const card = document.createElement('div');
                    card.className = 'suggestion-card';
                    card.innerHTML = `<h4>${suggestion.title}</h4><p>${suggestion.idea}</p>`;
                    grid.appendChild(card);
                });
            } catch (error) {
                console.error("Suggestion Error:", error);
                grid.innerHTML = '<p style="font-size:0.9rem; opacity:0.7;">Could not load suggestions.</p>';
            }
        }
    </script>
</body>
</html>

